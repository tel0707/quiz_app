{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz_type.name }} - Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f7f8fa;
        }

        .question-card {
            max-width: 700px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        .answers label {
            display: block;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .answers label:hover {
            background: #dfe7ff;
        }

        .answers input[type="radio"]:checked + label {
            background: #d0f5d0;
            border: 1px solid #28a745;
        }

        .pagination .page-item.active .page-link {
            background-color: #198754;
            border-color: #198754;
        }

        .timer {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .pagination .answered a {
            pointer-events: auto !important;
        }

        .pagination .page-link:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>

<!-- ðŸ”¹ NAVBAR (timer bilan) -->
<nav class="navbar navbar-dark bg-primary fixed-top">
    <div class="container-fluid justify-content-between">
        <span class="navbar-brand">{{ quiz_type.name }}</span>
        <div class="timer" id="timer"></div>
        <a href="{% url 'finish_quiz' %}" class="btn btn-warning btn-sm text-dark fw-bold">Testni tugatish</a>
    </div>
</nav>

<div style="margin-top: 80px;"></div>

<!-- ðŸ”¹ Savol kartasi -->
<div class="question-card">
    <h5><b>{{ page_obj.number }}.</b> {{ question.name }}</h5>
    <form method="post" id="quizForm">
        {% csrf_token %}
        <div class="answers mt-3">
            {% for ans in question.answers.all %}

                <input type="radio" class="btn-check" name="answer_{{ question.id }}" id="ans_{{ ans.id }}"

                       value="{{ ans.id }}" {% if ans.id in user_answers %}checked{% endif %}>
                <label class="btn btn-outline-secondary w-100 text-start" for="ans_{{ ans.id }}">
                    {{ ans.name }}
                </label>
            {% endfor %}
        </div>
    </form>
</div>

<!-- Pastdagi sahifalar navigatsiyasi -->
<nav aria-label="Savollar navigatsiyasi" class="mt-4">
    <ul class="pagination justify-content-center flex-wrap" id="pagination">
        {% for num in paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="{% url 'quiz_page' quiz_id=quiz.id page=num %}">{{ num }}</a>
            </li>
        {% endfor %}
    </ul>
</nav>
<script>
    // Sahifa raqamlari boâ€˜yicha yashil qilish
    let answeredQuestions = {{ answered_questions|safe }};

    function updatePaginationColors() {
        document.querySelectorAll('#pagination .page-item').forEach(item => {
            const link = item.querySelector('.page-link');
            if (!link) return;
            const pageNum = parseInt(link.textContent);

            if (answeredQuestions.includes(pageNum)) {
                item.classList.add('answered');
                link.className = 'page-link bg-success text-white border-success';
            }
            if ({{ page_obj.number }} === pageNum) {
                item.classList.add('active');
            }
        });
    }

    updatePaginationColors();

    // Timer
    let startTime = new Date("{{ request.session.quiz_start_time }}");
    let totalMinutes = {{ total_minutes }};
    let endTime = new Date(startTime.getTime() + totalMinutes * 60000);

    function updateTimer() {
        let now = new Date();
        let remaining = Math.max(0, Math.floor((endTime - now) / 1000));
        let m = String(Math.floor(remaining / 60)).padStart(2, '0');
        let s = String(remaining % 60).padStart(2, '0');
        document.getElementById("timer").textContent = `${m}:${s}`;

        if (remaining <= 0) {
            clearInterval(timerInterval);
            alert("Vaqt tugadi!");
            window.location.href = "{% url 'finish_quiz' %}";
        }
    }

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // Javob saqlash
    document.querySelectorAll("input[type='radio']").forEach(el => {
        el.addEventListener("change", function () {
            fetch("{% url 'save_answer' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({
                    question_id: this.name.replace("answer_", ""),
                    answer_id: this.value
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        answeredQuestions = data.answered_questions;
                        updatePaginationColors();

                        // âœ… TO'G'RI YONDASHUV: Avtomatik o'tishni o'chirish
                        // Foydalanuvchi qo'lda sahifalarni almashtirsin

                        // Yoki agar avtomatik o'tish kerak bo'lsa:
                        const currentPage = {{ page_obj.number }};
                        const totalPages = {{ paginator.num_pages }};

                        if (currentPage < totalPages) {
                            // Keyingi sahifaga o'tish
                            setTimeout(() => {
                                location.href = "{% url 'quiz_page' quiz_id=quiz.id page=1 %}".replace('/1/', '/' + (currentPage + 1) + '/');
                            }, 300);
                        } else {
                            // Oxirgi sahifada - testni tugatish
                            setTimeout(() => location.href = "{% url 'finish_quiz' %}", 500);
                        }
                    }
                });
        });
    });
</script>
